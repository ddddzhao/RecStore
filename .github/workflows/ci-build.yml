name: Build (CPU)

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      TORCH_VERSION: "2.5.0"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 0

      - name: Cache submodules git data
        uses: actions/cache@v4
        with:
          path: .git/modules
          key: submodules-${{ runner.os }}-${{ hashFiles('.gitmodules') }}
          restore-keys: |
            submodules-${{ runner.os }}-${{ hashFiles('.gitmodules') }}
            submodules-${{ runner.os }}-

      - name: Update submodules
        run: |
          set -euo pipefail
          git submodule sync --recursive
          git submodule update --init --recursive --jobs 4 --depth 0

      - name: Free disk space
        run: |
          set -euxo pipefail
          df -h
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android /opt/hostedtoolcache || true
          sudo docker system prune -af || true
          df -h

      - name: Install host prerequisites
        run: |
          set -euo pipefail
          export DEBIAN_FRONTEND=noninteractive
          bash dockerfiles/init_host_prereqs.sh

      - name: Init env inside docker
        run: |
          set -euo pipefail
          export DEBIAN_FRONTEND=noninteractive
          CI_THROTTLE_MAKE=1 LIBTORCH_VARIANT=cpu SKIP_SPDK=1 SKIP_HUGECTR=1 SKIP_LIBIBVERBS=1 \
            bash dockerfiles/init_env_inside_docker.sh

      - name: Install PyTorch wheel
        env:
          TORCH_VERSION: "${{ env.TORCH_VERSION }}"
        run: |
          set -euo pipefail
          bash dockerfiles/build_torch_wheel.sh
          WHL=$(ls -1 binary/torch-${TORCH_VERSION}*linux_x86_64.whl | head -n1)
          python3 -m pip install --no-cache-dir "$WHL"

      - name: Upload torch wheel
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: torch-wheel
          path: binary/torch-${{ env.TORCH_VERSION }}*linux_x86_64.whl

      - name: Configure CMake
        run: |
          set -euo pipefail
          mkdir -p build
          cd build
          cmake -DENABLE_CUDA=OFF -DCMAKE_BUILD_TYPE=Debug -DCMAKE_POLICY_VERSION_MINIMUM=3.5 ..

      - name: Build
        run: |
          set -euo pipefail
          cd build
          make -j4

      - name: Upload build directory
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: build-folder
          path: build/

      # - name: Configure CMake (Mock KV)
      #   run: |
      #     set -euo pipefail
      #     mkdir -p build
      #     cd build
      #     cmake -DENABLE_CUDA=OFF -DCMAKE_BUILD_TYPE=Debug -DCMAKE_POLICY_VERSION_MINIMUM=3.5 .. -DUSE_FAKE_KVCLIENT=ON

      # - name: Build (Mock KV)
      #   run: |
      #     set -euo pipefail
      #     cd build
      #     make -j4

      # - name: Upload build directory (Mock KV)
      #   if: success()
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: build-folder-mock
      #     path: build/

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            init_env_*.log
            build/CMakeCache.txt
            build/compile_commands.json

      - name: Upload recstore ops library
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: recstore-ops
          path: build/lib/lib_recstore_ops.so

  # test-mock:
  #   name: Test OP Layer with Mock KV
  #   needs: build
  #   runs-on: ubuntu-latest
  #   env:
  #     TORCH_VERSION: "2.5.0"
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #       with:
  #         submodules: false
  #         fetch-depth: 0

  #     - name: Download mock build folder
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: build-folder-mock
  #         path: build

  #     - name: Download recstore ops (mock)
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: recstore-ops
  #         path: ops

  #     - name: Download torch wheel
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: torch-wheel
  #         path: wheel

  #     - name: Install host prerequisites
  #       run: |
  #         set -euo pipefail
  #         export DEBIAN_FRONTEND=noninteractive
  #         bash dockerfiles/init_host_prereqs.sh

  #     - name: Install wheel
  #       run: |
  #         set -euo pipefail
  #         ls -la build/lib || true
  #         # Ensure lib_recstore_ops.so exists
  #         if [ ! -f build/lib/lib_recstore_ops.so ]; then
  #           mkdir -p build/lib
  #           cp ops/lib_recstore_ops.so build/lib/
  #         fi
  #         WHL=$(ls -1 wheel/torch-${TORCH_VERSION}*linux_x86_64.whl | head -n1)
  #         python3 -m pip install --no-cache-dir "$WHL"

  #     - name: Run ci/test scripts
  #       run: |
  #         set -euo pipefail
  #         for f in ci/test/*.sh; do
  #           echo "Running $f";
  #           bash "$f" --mock;
  #         done

  #     - name: Run CTest
  #       run: |
  #         set -euo pipefail
  #         cd build
  #         ctest --verbose

  # test:
  #   name: Test Storage Layer
  #   needs: build
  #   runs-on: ubuntu-latest
  #   env:
  #     TORCH_VERSION: "2.5.0"
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #       with:
  #         submodules: false
  #         fetch-depth: 0

  #     - name: Download mock build folder
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: build-folder
  #         path: build

  #     - name: Download torch wheel
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: torch-wheel
  #         path: wheel

  #     - name: Install host prerequisites
  #       run: |
  #         set -euo pipefail
  #         export DEBIAN_FRONTEND=noninteractive
  #         bash dockerfiles/init_host_prereqs.sh

  #     - name: Install wheel
  #       run: |
  #         set -euo pipefail
  #         ls -la build/lib || true
  #         WHL=$(ls -1 wheel/torch-${TORCH_VERSION}*linux_x86_64.whl | head -n1)
  #         python3 -m pip install --no-cache-dir "$WHL"

  #     - name: Run ci/test scripts
  #       run: |
  #         set -euo pipefail
  #         for f in ci/test/*.sh; do
  #           echo "Running $f";
  #           bash "$f";
  #         done

      # - name: Run CTest
      #   run: |
      #     set -euo pipefail
      #     cd build
      #     ctest --verbose